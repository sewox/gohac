---
import Layout from '../../layouts/Layout.astro';

const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3131';

interface Post {
  id: string;
  slug: string;
  title: string;
  excerpt: string;
  featured_image?: string;
  published_at: string | null;
  created_at: string;
  author?: {
    name: string;
    email: string;
  };
  categories?: Array<{
    id: string;
    name: string;
    slug: string;
  }>;
}

let posts: Post[] = [];
let total = 0;
let error: string | null = null;

try {
  const limit = 10;
  const offset = 0;
  const response = await fetch(`${API_BASE_URL}/api/public/posts?limit=${limit}&offset=${offset}`);
  
  if (response.ok) {
    const data = await response.json();
    posts = data.data || [];
    total = data.total || 0;
  } else {
    error = `Failed to load posts: ${response.statusText}`;
  }
} catch (err) {
  console.error('Error fetching posts:', err);
  error = err instanceof Error ? err.message : 'Failed to load posts';
}
---

<Layout title="Blog" description="Latest blog posts">
  <main class="blog-page">
    <div class="blog-container">
      <header class="blog-header">
        <h1>Blog</h1>
        <p class="blog-subtitle">Latest posts and updates</p>
      </header>

      {error ? (
        <div class="error-message">
          <p>{error}</p>
        </div>
      ) : posts.length === 0 ? (
        <div class="empty-state">
          <p>No posts yet. Check back soon!</p>
        </div>
      ) : (
        <div class="posts-grid">
          {posts.map((post) => (
            <article class="post-card">
              {post.featured_image && (
                <div class="post-image">
                  <img src={post.featured_image.startsWith('http') ? post.featured_image : `${API_BASE_URL}${post.featured_image.startsWith('/') ? post.featured_image : '/' + post.featured_image}`} alt={post.title} />
                </div>
              )}
              <div class="post-content">
                <div class="post-meta">
                  {post.published_at && (
                    <time datetime={post.published_at}>
                      {new Date(post.published_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </time>
                  )}
                  {post.categories && post.categories.length > 0 && (
                    <div class="post-categories">
                      {post.categories.map((cat) => (
                        <span class="category-tag">{cat.name}</span>
                      ))}
                    </div>
                  )}
                </div>
                <h2 class="post-title">
                  <a href={`/blog/${post.slug}`}>{post.title}</a>
                </h2>
                {post.excerpt && (
                  <p class="post-excerpt">{post.excerpt}</p>
                )}
                <a href={`/blog/${post.slug}`} class="read-more">
                  Read more â†’
                </a>
              </div>
            </article>
          ))}
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  .blog-page {
    min-height: calc(100vh - 200px);
    padding: 3rem 1.5rem;
  }

  .blog-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .blog-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .blog-header h1 {
    font-size: 3rem;
    font-weight: 700;
    color: #f7fafc;
    margin-bottom: 0.5rem;
  }

  .blog-subtitle {
    font-size: 1.25rem;
    color: #a0aec0;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
  }

  .post-card {
    background-color: #1a202c;
    border: 1px solid #2d3748;
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .post-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  }

  .post-image {
    width: 100%;
    height: 200px;
    overflow: hidden;
    background-color: #2d3748;
  }

  .post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-content {
    padding: 1.5rem;
  }

  .post-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: #718096;
  }

  .post-categories {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .category-tag {
    background-color: #2d3748;
    color: #4299e1;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
  }

  .post-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #f7fafc;
    margin-bottom: 0.75rem;
  }

  .post-title a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s;
  }

  .post-title a:hover {
    color: #4299e1;
  }

  .post-excerpt {
    color: #cbd5e0;
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .read-more {
    color: #4299e1;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .read-more:hover {
    color: #63b3ed;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #718096;
  }

  .error-message {
    text-align: center;
    padding: 2rem;
    color: #fc8181;
    background-color: #2d1b1b;
    border-radius: 8px;
  }

  @media (max-width: 768px) {
    .posts-grid {
      grid-template-columns: 1fr;
    }

    .blog-header h1 {
      font-size: 2rem;
    }
  }
</style>

